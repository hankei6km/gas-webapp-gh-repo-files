<!DOCTYPE html>
<html>
  <head>
    <title>My Website</title>
    <meta charset="UTF-8" />
    <!--https://qiita.com/takatama/items/96c9fa5fbf0fe18427a3 -->
    <style>
      <?!= HtmlService.createHtmlOutputFromFile(staticPath_('index.css.html')).getContent(); ?>
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="flex justify-center">
      <div class="w-800 m-4">
        <h1 class="text-2xl font-bold mb-4">
          リポジトリのファイルツリーを Google ドライブへ保存
        </h1>
        <form class="mb-4">
          <div class="mb-2 flex flex-row justify-between">
            <input
              type="text"
              class="w-full px-2 py-1 border border-gray-300 rounded"
              id="repo-url"
            />
          </div>
          <div class="mb-2 flex flex-row justify-between">
            <div class="w-1/2">
              <button
                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
                id="run-button"
                onclick="handleRun()"
              >
                Run
              </button>
            </div>
            <div class="w-1/2 flex justify-end">
              <select
                class="px-2 py-1 border border-gray-300 rounded"
                id="file-format"
              >
                <option value="document">Document</option>
                <option value="html">HTML</option>
                <option value="markdown">Markdown</option>
                <option value="pdf">PDF</option>
              </select>
            </div>
          </div>
        </form>
        <div>
          <div
            class="w-full px-2 py-1 border border-gray-300 rounded"
            id="response-message"
            style="display: none"
          >
            <span style="color: green"
              ><span id="response-message-text"></span
            ></span>
            <a
              href="https://drive.google.com/drive/my-drive"
              target="_blank"
              rel="noopener noreferrer"
              id="response-message-link"
              >ファイルを表示</a
            >
          </div>
          <div
            class="w-full px-2 py-1 border border-gray-300 rounded"
            id="response-error"
            style="display: none"
          >
            <span style="color: red"
              ><span id="response-error-text"></span
            ></span>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    function disableInputs() {
      document.getElementById('repo-url').disabled = true
      document.getElementById('run-button').disabled = true
    }
    function enableInputs() {
      document.getElementById('repo-url').disabled = false
      document.getElementById('run-button').disabled = false
    }
    function handleRun() {
      disableInputs()
      resetResponse()
      new Promise((resolve, reject) => {
        const repoText = document.getElementById('repo-url').value
        const fileFormat = document.getElementById('file-format').value
        google.script.run
          .withSuccessHandler(function (message) {
            setResponseMessage(message)
            resolve()
          })
          .withFailureHandler(function (error) {
            setResponseError(error.message)
            // reject()
            resolve()
          })
          .repoToFile({ url: repoText, fileFormat: fileFormat.toLowerCase() })
      }).then(() => {
        enableInputs()
      })
    }
    function resetResponse() {
      document.getElementById('response-message').style.display = 'none'
      document.getElementById('response-message-text').textContent = ''
      document.getElementById('response-message-link').href =
        'https://drive.google.com/drive/my-drive'
      document.getElementById('response-error').style.display = 'none'
      document.getElementById('response-error-text').textContent = ''
    }
    function setResponseMessage(message) {
      document.getElementById('response-message').style.display = 'block'
      document.getElementById('response-message-text').textContent =
        message.done
      document.getElementById('response-message-link').href = message.url
      document.getElementById('response-error').style.display = 'none'
      document.getElementById('response-error-text').textContent = ''
    }
    function setResponseError(error) {
      document.getElementById('response-message').style.display = 'none'
      document.getElementById('response-message-text').textContent = ''
      document.getElementById('response-error').style.display = 'block'
      document.getElementById('response-error-text').textContent = error
    }
  </script>
</html>
